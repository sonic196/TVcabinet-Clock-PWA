<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TVcabinet Clock (v15 Test)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&display=swap');

        :root {
            --bg-color: #000000;
            --color-a: #52a9ff;
            --color-b: #52a9ff;
            --color-c: color-mix(in srgb, white 80%, var(--color-a));
            --text-color-night: #ff0000;
            --liquid-opacity: 0.3;
            --scale-color: #ffffff;
            --scale-width: 1.5;
        }

        @property --scale-width {
            syntax: '<number>';
            initial-value: 1;
            inherits: true;
        }

        @property --mask-y-px {
            syntax: '<length>';
            initial-value: 100vh;
            inherits: false;
        }

        @property --wave-height {
            syntax: '<length>';
            initial-value: 75px;
            inherits: true;
        }

        body {
            --wave-height: 75px;
            /* Default Medium */
            background-color: var(--bg-color);
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        #liquid-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            z-index: 1;
            pointer-events: none;
            transition: height 1s linear;
            opacity: 0;
            visibility: hidden;
        }

        body.show-liquid #liquid-container {
            opacity: 1;
            visibility: visible;
        }

        #liquid-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-a);
            opacity: var(--liquid-opacity);
            transition: background-color 2s ease;
        }

        #liquid-surface {
            position: absolute;
            top: calc(var(--wave-height) * -1);
            left: 0;
            width: 200%;
            height: var(--wave-height);
            background-color: var(--color-a);
            opacity: var(--liquid-opacity);
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 100' preserveAspectRatio='none'%3E%3Cpath d='M0,50 Q250,0 500,50 T1000,50 L1000,100 L0,100 Z' fill='black' /%3E%3C/svg%3E");
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 100' preserveAspectRatio='none'%3E%3Cpath d='M0,50 Q250,0 500,50 T1000,50 L1000,100 L0,100 Z' fill='black' /%3E%3C/svg%3E");
            mask-size: 50% 100%;
            -webkit-mask-size: 50% 100%;
            mask-repeat: repeat-x;
            -webkit-mask-repeat: repeat-x;
            /* JS Controlled Animation for Sync */
            /* width: 200% so we translate from 0 to -50% (which is -100vw) */
            transform: translateX(var(--wave-x, 0px));
            /* will-change removed for power saving */
            transition: background-color 2s ease;
        }

        /* Keyframes removed - moved to JS */

        #liquid-container.surface-flat #liquid-surface {
            display: none;
        }

        body.line-mode #liquid-surface,
        body.line-mode #liquid-fill {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        body.line-mode.show-water-fill #liquid-fill {
            display: block !important;
            visibility: visible !important;
            opacity: var(--liquid-opacity) !important;
        }

        #liquid-scale {
            position: fixed;
            left: 0;
            top: 0;
            width: 60px;
            height: 100%;
            z-index: 3;
            pointer-events: none;
            display: none;
        }

        body.show-liquid.line-mode #liquid-scale {
            display: block;
        }

        /* Smart Scale Alignment: If .scale-flipped is present, move to right */
        body.scale-flipped #liquid-scale {
            left: auto;
            right: 0;
        }

        body.scale-flipped .scale-mark {
            left: auto;
            right: 0;
        }

        body.scale-flipped #liquid-second-label {
            left: auto;
            right: 25px;
            text-align: right;
        }

        /* Adjust padding when scale is flipped to avoid overlap */
        body.scale-flipped #clock-container,
        body.scale-flipped #clock-container-swap {
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(80px, env(safe-area-inset-right));
        }

        .scale-mark {
            position: absolute;
            left: 0;
            width: calc(8px * var(--scale-width));
            height: calc(1.5px * var(--scale-width));
            background-color: var(--scale-color);
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .scale-mark.medium {
            width: calc(12px * var(--scale-width));
            height: calc(2px * var(--scale-width));
            opacity: 0.8;
        }

        .scale-mark.major {
            width: calc(16px * var(--scale-width));
            height: calc(2.5px * var(--scale-width));
            opacity: 0.9;
        }

        .scale-mark.current {
            width: calc(28px * var(--scale-width)) !important;
            height: calc(3.5px * var(--scale-width)) !important;
            opacity: 1 !important;
            box-shadow: 0 0 8px var(--scale-color);
        }

        #liquid-second-label {
            position: fixed;
            left: 25px;
            bottom: 10px;
            font-size: 18px;
            color: var(--color-a);
            font-weight: 700;
            z-index: 6;
            transition: bottom 0.3s ease, top 0.3s ease, color 2s ease;
            display: none;
        }

        body.show-liquid.line-mode #liquid-second-label {
            display: block;
        }

        #liquid-container.step-anim {
            transition: height 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        body.liquid-interact #clock-container,
        body.liquid-interact #date,
        body.liquid-interact #ampm-standalone {
            mix-blend-mode: difference;
        }

        #clock-container {
            text-align: center;
            transition: transform 60s linear;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
        }

        #time-row {
            display: flex;
            align-items: baseline;
            justify-content: center;
            position: relative;
        }

        #time {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40vw;
            /* Unified 40vw */
            line-height: 0.8;
            font-weight: 900;
            letter-spacing: -0.05em;
            position: relative;
            transition: font-size 0.5s ease;
        }

        .digit-wrapper {
            position: relative;
            display: inline-block;
            margin: 0 -1vw;
            /* Tighter margins for larger digits */
            width: 22vw;
            height: 28vw;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: width 0.5s ease, margin 0.5s ease;
        }

        .digit {
            position: absolute;
            transition: transform 0.3s ease-out, opacity 0.5s ease;
            mix-blend-mode: screen;
            opacity: 0.9;
            /* will-change removed for power saving */
        }

        .digit-wrapper:nth-child(1) .digit,
        .digit-wrapper:nth-child(4) .digit {
            color: var(--color-a);
        }

        .digit-wrapper:nth-child(2) .digit,
        .digit-wrapper:nth-child(5) .digit {
            color: var(--color-b);
        }

        .colon {
            font-size: 20vw;
            margin: 0 -1vw;
            padding-bottom: 2vw;
            color: var(--color-c);
            mix-blend-mode: screen;
            position: relative;
            z-index: 2;
            transition: color 2s ease, font-size 0.5s ease;
        }

        .mode-12h #time {
            font-size: 40vw;
            /* Unified 40vw */
        }

        .mode-12h .digit-wrapper {
            width: 22vw;
            margin: 0 -1vw;
            /* Standardized to match 24H */
        }

        .mode-12h .colon {
            font-size: 20vw;
            /* Standardized colon size */
            margin: 0 -1vw;
            /* Standardized colon margin */
            padding-bottom: 2vw;
        }

        body.hide-date #date {
            display: none !important;
        }

        /* Match Swap Clock's 48vw for Landscape Hide Date */
        body.hide-date #time,
        body.hide-date.mode-12h #time {
            font-size: 48vw;
        }

        body.hide-date .digit-wrapper,
        body.hide-date.mode-12h .digit-wrapper {
            width: 26.5vw;
        }

        /* ... */
        #clock-container-swap.mode-12h #time-swap {
            font-size: 40vw;
            /* Unified 40vw */
        }

        #clock-container-swap.mode-12h .digit-wrapper {
            width: 22vw;
            margin: 0 -1vw;
            /* Standardized */
        }

        .blink {
            animation: blinker 2s linear infinite;
        }

        @keyframes blinker {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.1;
            }
        }

        #date {
            position: fixed;
            font-size: 4vw;
            color: var(--color-a);
            opacity: 0.8;
            font-weight: 700;
            letter-spacing: 2px;
            z-index: 25;
            transition: color 2s ease;
            line-height: 1.2;
            white-space: nowrap;
        }

        #ampm-standalone {
            position: fixed;
            font-size: 5vw;
            font-weight: 800;
            color: var(--color-c);
            opacity: 0;
            display: none;
            z-index: 25;
            transition: opacity 0.5s ease, color 2s ease;
        }

        #ampm-standalone.visible {
            opacity: 1;
            display: block;
        }

        @media (orientation: landscape) {
            #date {
                bottom: max(20px, env(safe-area-inset-bottom));
                right: max(20px, env(safe-area-inset-right));
            }

            #ampm-standalone {
                bottom: max(55px, calc(env(safe-area-inset-bottom) + 35px));
                right: max(20px, env(safe-area-inset-right));
            }

            /* Shift Date/AMPM when Scale is Flipped (Right Side) */
            body.scale-flipped #date,
            body.scale-flipped #ampm-standalone {
                right: max(85px, env(safe-area-inset-right));
            }
        }

        #controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 30;
            pointer-events: none;
        }

        body:active #controls,
        body.show-controls #controls {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }

        .btn-text {
            margin-left: 5px;
        }

        #palette-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            padding: 15px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            z-index: 40;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 300px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
            transform: translateY(20px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #palette-panel.visible {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .palette-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s, transform 0.1s;
        }

        .palette-item:active {
            transform: scale(0.98);
        }

        .palette-item.active {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .palette-item.disabled {
            opacity: 0.3;
            filter: grayscale(1);
        }

        .palette-item.disabled .palette-name {
            text-decoration: line-through;
        }

        .palette-preview {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .palette-name {
            font-size: 13px;
            font-weight: 600;
        }

        @media (orientation: portrait) {
            #palette-panel {
                bottom: 80px;
                left: 50%;
                right: auto;
                transform: translateX(-50%) translateY(20px);
                width: 85vw;
                max-width: 350px;
            }

            #palette-panel.visible {
                transform: translateX(-50%) translateY(0);
            }
        }

        #liquid-settings-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            z-index: 40;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 250px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
            transform: translateY(20px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #liquid-settings-panel.visible {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .panel-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .panel-section.disabled {
            opacity: 0.4;
        }

        .panel-section.disabled .panel-options {
            pointer-events: none;
        }

        .panel-section.disabled .panel-title {
            color: #666;
        }

        .panel-title {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .panel-options {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 2px;
        }

        .panel-option {
            flex: 1;
            text-align: center;
            padding: 6px 0;
            font-size: 13px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .panel-option.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }

        body.night-mode {
            --color-a: var(--text-color-night) !important;
            --color-b: var(--text-color-night) !important;
            --color-c: var(--text-color-night) !important;
        }

        body.night-mode .digit,
        body.night-mode .colon {
            mix-blend-mode: normal;
            opacity: 0.5;
        }

        body.night-mode #date {
            color: var(--text-color-night);
            opacity: 0.4;
        }

        body.night-mode #liquid-fill,
        body.night-mode #liquid-surface {
            background-color: var(--text-color-night);
            opacity: 0.1 !important;
        }

        #night-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
            z-index: 20;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: black;
            color: white;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            position: fixed;
            width: 100%;
            touch-action: none;
        }

        #minutes-row {
            display: none;
        }

        @media (orientation: portrait) {
            #clock-container {
                justify-content: center;
                flex-direction: column;
                gap: 2vh;
            }

            #time-row {
                flex-direction: column;
                align-items: center;
                gap: 0;
            }

            #time {
                font-size: 80vw !important;
                line-height: 0.7 !important;
            }

            .digit-wrapper {
                width: 64vw !important;
                height: 65vw !important;
                margin: 0 -9vw !important;
            }

            #time .colon,
            #time .digit-wrapper:nth-child(4),
            #time .digit-wrapper:nth-child(5) {
                display: none !important;
            }

            #time .digit-wrapper:nth-child(1) .digit,
            #time .digit-wrapper:nth-child(2) .digit {
                color: var(--color-a);
            }

            #minutes-row {
                display: flex;
                align-items: baseline;
                justify-content: center;
                font-size: 80vw;
                line-height: 0.7;
                font-weight: 900;
                letter-spacing: -0.05em;
            }

            #minutes-row .digit-wrapper {
                position: relative;
                margin: 0 -9vw;
                width: 64vw;
                height: 65vw;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            #minutes-row .digit {
                position: absolute;
                transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 3s ease, color 2s ease;
                mix-blend-mode: screen;
                opacity: 0.9;
                color: var(--color-b);
            }

            #date {
                position: static;
                font-size: 6vw;
                margin: 1vh 0;
            }

            #date.blink {
                animation: blinker 2s linear infinite;
            }

            /* Force Date Visible in Portrait - Override hide-date class */
            body.hide-date #date {
                display: block !important;
                opacity: 0.8;
            }

            #controls {
                bottom: max(10px, env(safe-area-inset-bottom));
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                flex-direction: row;
                flex-wrap: nowrap;
                justify-content: center;
                gap: 8px;
                max-width: 95vw;
            }

            #liquid-settings-panel {
                bottom: 80px;
                left: 50%;
                right: auto;
                max-height: calc(100vh - 160px);
                transform: translateX(-50%) translateY(20px);
            }

            #liquid-settings-panel.visible {
                transform: translateX(-50%) translateY(0);
            }

            .btn {
                min-width: 45px;
                padding: 10px;
                font-size: 16px;
            }

            .btn-text {
                display: none;
            }

            body.hide-date #time {
                font-size: 90vw !important;
            }

            body.hide-date #minutes-row {
                font-size: 90vw !important;
            }

            body.hide-date .digit-wrapper,
            body.hide-date #minutes-row .digit-wrapper {
                width: 72vw !important;
                height: 75vw !important;
                margin: 0 -10vw !important;
            }
        }

        /* Swap Clock Container - Base Styles */
        #clock-container-swap {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 11;
            /* Above main clock (10), below controls */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
            box-sizing: border-box;

            /* Hardware Acceleration Re-enabled for Performance/Heat Optimization */
            transform: translate3d(0, 0, 0);
            contain: paint layout;
            /* Isolate layout/paint */
            backface-visibility: hidden;
            /* Further GPU hint */

            /* Sync Mechanism: Always Display but Hide Opacity */
            display: flex;
            opacity: 0;
            pointer-events: none;

            /* SYNCED WAVE MASK */
            --mask-y-px: 100vh;
            /* --wave-x is set by JS for perfect sync with liquid */

            mask-image:
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 100' preserveAspectRatio='none'%3E%3Cpath d='M0,50 Q250,0 500,50 T1000,50 L1000,100 L0,100 Z' fill='black' /%3E%3C/svg%3E"),
                linear-gradient(to top, black 0%, black 100%);
            -webkit-mask-image:
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 100' preserveAspectRatio='none'%3E%3Cpath d='M0,50 Q250,0 500,50 T1000,50 L1000,100 L0,100 Z' fill='black' /%3E%3C/svg%3E"),
                linear-gradient(to top, black 0%, black 100%);

            /* Mask Size: 100% width (100vw). Height set by --wave-height */
            mask-size: 100% var(--wave-height), 100% 200%;
            -webkit-mask-size: 100% var(--wave-height), 100% 200%;

            mask-repeat: repeat-x, no-repeat;
            -webkit-mask-repeat: repeat-x, no-repeat;

            mask-composite: add;
            -webkit-mask-composite: source-over;

            /* Position: X is driven by --wave-x. Y is driven by --mask-y-px */
            /* Note: Liquid moves LEFT (negative X). Mask needs to move LEFT (negative X). */
            /* Crucial Fix: The second layer (gradient) MUST NOT move horizontally! */
            mask-position: var(--wave-x, 0px) calc(var(--mask-y-px) - var(--wave-height) + 1px), 0px var(--mask-y-px);
            -webkit-mask-position: var(--wave-x, 0px) calc(var(--mask-y-px) - var(--wave-height) + 1px), 0px var(--mask-y-px);

            /* Optimization - will-change removed for power saving */
            /* will-change: mask-position; */

            /* Transition for height matching - NO animation for X (handled by variable) */
            transition: --mask-y-px 1s linear, opacity 0.3s ease, mask-size 0.5s ease, -webkit-mask-size 0.5s ease;
        }

        body.swap-active.show-liquid #clock-container-swap {
            opacity: 1;
        }

        /* Wave animation REMOVED - using flat mask only */

        /* Swapped Colors */
        #clock-container-swap .digit-wrapper:nth-child(1) .digit,
        #clock-container-swap .digit-wrapper:nth-child(4) .digit {
            color: var(--color-b);
            mix-blend-mode: normal;
            /* Ensure it covers the digit below */
        }

        #clock-container-swap .digit-wrapper:nth-child(2) .digit,
        #clock-container-swap .digit-wrapper:nth-child(5) .digit {
            color: var(--color-a);
            mix-blend-mode: normal;
            /* Ensure it covers the digit below */
        }

        #clock-container-swap .colon {
            opacity: 1;
            /* Visible to ensuring alignment, color stays white */
            color: var(--scale-color);
        }

        /* Ensure layout matches main clock exactly */
        #clock-container-swap #time-row-swap {
            display: flex;
            align-items: baseline;
            justify-content: center;
            position: relative;
        }

        /* Pointer Events for Panels - Prevent clicking when hidden */
        #palette-panel,
        #liquid-settings-panel {
            pointer-events: none;
        }

        #palette-panel.visible,
        #liquid-settings-panel.visible {
            pointer-events: auto;
        }

        /* Swap Wave Overrides for Flat/Line Modes */
        /* When surface is Flat or Line, the Swap Mask should also be flat (no wave) */
        body.swap-active.show-liquid .surface-flat~#clock-container-swap,
        body.swap-active.line-mode #clock-container-swap {
            mask-image: linear-gradient(to top, black 0%, black 100%);
            -webkit-mask-image: linear-gradient(to top, black 0%, black 100%);
            mask-size: 100% 200%;
            -webkit-mask-size: 100% 200%;
            mask-position: 0px var(--mask-y-px);
            -webkit-mask-position: 0px var(--mask-y-px);
            animation: none;
        }

        /* Specifically target surface-flat on liquid container triggering the body state logic or use direct sibling/parent checks? 
           Actually, JS toggles classes on liquidContainer. 
           But for line-mode, class is on BODY.
           For flat mode, class is on liquidContainer? 
           JS: liquidContainer.classList.add('surface-' + surface); 
           Wait, there is no body class for flat. 
           I need to check how to target 'flat' mode. 
           liquidContainer has class 'surface-flat'. 
           liquidContainer is sibling of clock-container-swap? No.
           Structure:
           body
             liquid-container
             clock-container-swap
           So general sibling selector: #liquid-container.surface-flat ~ #clock-container-swap works!
        */
        body.swap-active #liquid-container.surface-flat~#clock-container-swap {
            mask-image: linear-gradient(to top, black 0%, black 100%);
            -webkit-mask-image: linear-gradient(to top, black 0%, black 100%);
            mask-size: 100% 200%;
            -webkit-mask-size: 100% 200%;
            mask-position: 0px var(--mask-y-px);
            -webkit-mask-position: 0px var(--mask-y-px);
            animation: none;
        }

        #clock-container-swap #time-swap {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40vw;
            /* Unified 40vw */
            line-height: 0.8;
            font-weight: 900;
            letter-spacing: -0.05em;
            position: relative;
            transition: font-size 0.5s ease;
        }

        #clock-container-swap #minutes-row-swap {
            display: none;
        }

        /* 12H Mode Adjustments for Swap */
        #clock-container-swap.mode-12h #time-swap {
            font-size: 40vw;
            /* Unified 40vw */
        }

        #clock-container-swap.mode-12h .digit-wrapper {
            width: 22vw;
            margin: 0 -1vw;
            /* Standardized Margin */
        }

        /* Hide Date adjustments (since date is hidden in swap anyway) */
        body.hide-date #clock-container-swap #time-swap {
            font-size: 48vw;
            /* Updated to 48vw */
        }

        body.hide-date.mode-12h #clock-container-swap #time-swap {
            font-size: 48vw;
            /* Updated to 48vw */
        }

        /* Fix Wrapper Width for Swap Clock Landscape Hide Date */
        body.hide-date #clock-container-swap .digit-wrapper,
        body.hide-date.mode-12h #clock-container-swap .digit-wrapper {
            width: 26.5vw;
        }

        /* Portrait Mode Sync */
        @media (orientation: portrait) {
            #clock-container-swap {
                gap: 2vh;
            }

            #clock-container-swap #time-row-swap {
                flex-direction: column;
                align-items: center;
                gap: 0;
            }

            #clock-container-swap #time-swap {
                font-size: 80vw !important;
                line-height: 0.7 !important;
            }

            #clock-container-swap #minutes-row-swap {
                display: flex;
                align-items: baseline;
                justify-content: center;
                font-size: 80vw;
                line-height: 0.7;
                font-weight: 900;
                letter-spacing: -0.05em;
            }

            #clock-container-swap .digit-wrapper {
                width: 64vw !important;
                height: 65vw !important;
                margin: 0 -9vw !important;
            }

            body.hide-date #clock-container-swap #minutes-row-swap {
                font-size: 90vw !important;
            }

            body.hide-date #clock-container-swap .digit-wrapper,
            body.hide-date #clock-container-swap #minutes-row-swap .digit-wrapper {
                width: 72vw !important;
                height: 75vw !important;
                margin: 0 -10vw !important;
            }

            /* Colon and minutes should remain visible in portrait swap to match layout */
            /* Correctly hide colon and minutes in time-swap for Portrait, so only Minutes Row shows them */
            #clock-container-swap #time-swap .colon,
            #clock-container-swap #time-swap .digit-wrapper:nth-child(4),
            #clock-container-swap #time-swap .digit-wrapper:nth-child(5) {
                display: none !important;
            }

            /* Colors for minutes-row in Swap Mode (Portrait) */
            /* Normal: minutes are Color B */
            /* Swap: minutes should be Color A */
            #clock-container-swap #minutes-row-swap .digit {
                color: var(--color-a) !important;
            }

            /* Fix Swap Clock Portrait Colors: Hours should be solid Color B (Inverse of Main A) */
            #clock-container-swap #time-swap .digit-wrapper .digit {
                color: var(--color-b) !important;
            }

            body.hide-date #clock-container-swap #time-swap {
                font-size: 90vw !important;
            }

            body.hide-date #minutes-row-swap {
                font-size: 90vw !important;
            }

            body.hide-date #clock-container-swap .digit-wrapper,
            body.hide-date #minutes-row-swap .digit-wrapper {
                width: 72vw !important;
                height: 75vw !important;
                margin: 0 -10vw !important;
            }
        }

        /* New Settings Panels */
        .settings-panel {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 16px;
            z-index: 1000;
            min-width: 280px;
            max-width: 90vw;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
            pointer-events: none;
        }

        .settings-panel.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        .panel-header {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Performance Panel Specific */
        .perf-modes {
            gap: 4px;
        }

        .perf-modes .panel-option {
            font-size: 12px;
            padding: 8px 4px;
        }

        .perf-info {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .perf-details {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.8;
        }

        .perf-item span {
            color: #fff;
            font-weight: 600;
        }

        .perf-warnings {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 200, 0, 0.3);
        }

        .warning-title {
            color: #ffcc00 !important;
        }

        .perf-warning-list {
            font-size: 11px;
            color: rgba(255, 200, 0, 0.8);
            line-height: 1.6;
            margin-top: 4px;
        }

        .perf-warning-item {
            padding: 2px 0;
        }
    </style>
</head>

<body class="show-liquid">
    <div id="liquid-container">
        <div id="liquid-surface"></div>
        <div id="liquid-fill"></div>
    </div>
    <div id="liquid-scale"></div>
    <div id="liquid-second-label">0s</div>
    <div id="clock-container">
        <div id="time-row">
            <div id="time"></div>
            <div id="minutes-row"></div>
        </div>
    </div>

    <!-- Swap Clock (Below Water, revealed by mask) -->
    <div id="clock-container-swap">
        <div id="time-row-swap">
            <div id="time-swap"></div>
            <div id="minutes-row-swap"></div>
        </div>
    </div>
    <div id="date">1Êúà1Êó• ÈÄ±‰∏Ä</div>
    <div id="ampm-standalone"></div>
    <div id="night-overlay"></div>
    <div id="palette-panel">
        <!-- Generated by JS -->
    </div>
    <div id="liquid-settings-panel">
        <div class="panel-section">
            <div class="panel-title">Á∏ΩÈñãÈóú</div>
            <div class="panel-options">
                <div class="panel-option active" data-setting="master" data-value="on">ÈñãÂïü</div>
                <div class="panel-option" data-setting="master" data-value="off">ÈóúÈñâ</div>
            </div>
        </div>
        <div class="panel-section">
            <div class="panel-title">Ê∂≤Èù¢Ê®£Âºè</div>
            <div class="panel-options">
                <div class="panel-option active" data-setting="surface" data-value="wave">Ê≥¢Êµ™</div>
                <div class="panel-option" data-setting="surface" data-value="flat">ÈùúÈù¢</div>
                <div class="panel-option" data-setting="surface" data-value="line">ÂàªÂ∫¶</div>
            </div>
        </div>
        <div class="panel-section" id="section-waveheight">
            <div class="panel-title">Êµ™È´ò</div>
            <div class="panel-options">
                <div class="panel-option" data-setting="waveheight" data-value="40">Â∞è</div>
                <div class="panel-option active" data-setting="waveheight" data-value="75">‰∏≠</div>
                <div class="panel-option" data-setting="waveheight" data-value="120">Â§ß</div>
                <div class="panel-option" data-setting="waveheight" data-value="180">ÁâπÂ§ß</div>
            </div>
        </div>
        <div class="panel-section">
            <div class="panel-title">È°èËâ≤ÊøÉÂ∫¶</div>
            <div class="panel-options">
                <div class="panel-option" data-setting="opacity" data-value="0.15">Ê∑°</div>
                <div class="panel-option active" data-setting="opacity" data-value="0.3">Ê®ôÊ∫ñ</div>
                <div class="panel-option" data-setting="opacity" data-value="0.5">ÊøÉ</div>
            </div>
        </div>
        <div class="panel-section">
            <div class="panel-title">‰∏äÂçáÊïàÊûú</div>
            <div class="panel-options">
                <div class="panel-option active" data-setting="rise" data-value="smooth">Âπ≥Êªë</div>
                <div class="panel-option" data-setting="rise" data-value="step">ÁßíË∑≥</div>
            </div>
        </div>
        <div class="panel-section">
            <div class="panel-title">È°èËâ≤‰∫§‰∫í</div>
            <div class="panel-options">
                <div class="panel-option" data-setting="interact" data-value="on">ÂèçÂ∑Æ</div>
                <div class="panel-option" data-setting="interact" data-value="swap">‰∫§Êèõ</div>
                <div class="panel-option active" data-setting="interact" data-value="off">ÈóúÈñâ</div>
            </div>
        </div>
        <div class="panel-section">
            <div class="panel-title">ÈáçÁΩÆÊ®°Âºè</div>
            <div class="panel-options">
                <div class="panel-option active" data-setting="reset" data-value="instant">Áû¨Èñì</div>
                <div class="panel-option" data-setting="reset" data-value="drain">ÊéíÊ∞¥</div>
            </div>
        </div>
        <div class="panel-section disabled" id="section-scalewidth">
            <div class="panel-title">ÂàªÂ∫¶Á≤óÁ¥∞</div>
            <div class="panel-options">
                <div class="panel-option" data-setting="scalewidth" data-value="1">Á¥∞</div>
                <div class="panel-option active" data-setting="scalewidth" data-value="1.5">‰∏≠</div>
                <div class="panel-option" data-setting="scalewidth" data-value="2">Á≤ó</div>
            </div>
        </div>
        <div class="panel-section disabled" id="section-waterfill">
            <div class="panel-title">Ê∞¥ÈáèÂ°´ÂÖÖ</div>
            <div class="panel-options">
                <div class="panel-option" data-setting="waterfill" data-value="off">ÈóúÈñâ</div>
                <div class="panel-option active" data-setting="waterfill" data-value="on">ÈñãÂïü</div>
            </div>
        </div>
    </div>
    <div id="controls">
        <button class="btn" id="toggle-palette">üé®<span class="btn-text"> ÊèõËâ≤</span></button>
        <button class="btn" id="toggle-time-settings">‚è∞<span class="btn-text"> ÊôÇÈñì</span></button>
        <button class="btn" id="toggle-liquid">üåä<span class="btn-text"> Ê∂≤È´î</span></button>
        <button class="btn" id="toggle-performance">‚ö°<span class="btn-text"> ÊïàËÉΩ</span></button>
        <button class="btn" id="btn-random">üé≤<span class="btn-text"> Èö®Ê©ü</span></button>
        <button class="btn" id="toggle-night">üåô<span class="btn-text"> Â§úÈñì</span></button>
    </div>

    <!-- Time/Date Settings Panel -->
    <div id="time-settings-panel" class="settings-panel">
        <div class="panel-header">‚è∞ ÊôÇÈñìÊó•ÊúüË®≠ÂÆö</div>
        <div class="panel-section">
            <div class="panel-title">ÊôÇÂà∂</div>
            <div class="panel-options">
                <div class="panel-option" data-setting="format" data-value="12h">12H</div>
                <div class="panel-option active" data-setting="format" data-value="24h">24H</div>
            </div>
        </div>
        <div class="panel-section">
            <div class="panel-title">Êó•Êúü</div>
            <div class="panel-options">
                <div class="panel-option active" data-setting="date" data-value="show">È°ØÁ§∫</div>
                <div class="panel-option" data-setting="date" data-value="hide">Èö±Ëóè</div>
            </div>
        </div>
        <div class="panel-section">
            <div class="panel-title">ÂàÜÈöîÁ¨¶ÈñÉÁàç</div>
            <div class="panel-options">
                <div class="panel-option active" data-setting="blink" data-value="on">Èñã</div>
                <div class="panel-option" data-setting="blink" data-value="off">Èóú</div>
            </div>
        </div>
    </div>

    <!-- Performance Panel -->
    <div id="performance-panel" class="settings-panel">
        <div class="panel-header">‚ö° ÊïàËÉΩÊ®°Âºè</div>
        <div class="panel-section">
            <div class="panel-options perf-modes">
                <div class="panel-option" data-setting="perfmode" data-value="standard">üü¢ Ê®ôÊ∫ñ</div>
                <div class="panel-option active" data-setting="perfmode" data-value="powersave">üü° ÁúÅÈõª</div>
                <div class="panel-option" data-setting="perfmode" data-value="ultrasave">üî¥ Ê•µÁúÅ</div>
            </div>
        </div>
        <div class="panel-section perf-info">
            <div class="panel-title">üìã ÁõÆÂâçË®≠ÂÆö</div>
            <div class="perf-details">
                <div class="perf-item">‚Ä¢ Ê≥¢Êµ™ÂãïÁï´Ôºö<span id="perf-wave">15 fps</span></div>
                <div class="perf-item">‚Ä¢ Êï∏Â≠óÂãïÁï´Ôºö<span id="perf-digit">Ê∑°ÂÖ•Ê∑°Âá∫</span></div>
                <div class="perf-item">‚Ä¢ ÂãïÁï´ÊôÇÈï∑Ôºö<span id="perf-duration">0.5 Áßí</span></div>
                <div class="perf-item">‚Ä¢ GPU Âä†ÈÄüÔºö<span id="perf-gpu">ÂÅúÁî®</span></div>
            </div>
        </div>
        <div class="panel-section perf-warnings" id="perf-warnings-section" style="display: none;">
            <div class="panel-title warning-title">‚ö†Ô∏è ‰ª•‰∏ãÂäüËÉΩÂ∑≤Ë¢´ÈôêÂà∂</div>
            <div class="perf-warning-list" id="perf-warning-list">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>
    <script>
        const BURN_IN_INTERVAL = 60000, MAX_JITTER = 20;
        const PALETTE_DATA = [
            { name: "Á∂ìÂÖ∏Ëóç", colors: ['#4facfe', '#00f2fe'], enabled: true },
            { name: "Êó•ËêΩÊ∞õÂúç", colors: ['#ff0844', '#ffb199'], enabled: true },
            { name: "Ê•µÂÖâÁ∂†", colors: ['#0ba360', '#3cba92'], enabled: true },
            { name: "ÁöáÂÆ∂Á¥´", colors: ['#667eea', '#764ba2'], enabled: true },
            { name: "ÈõªÂÖâÁ¥´", colors: ['#f77062', '#fe5196'], enabled: true },
            { name: "ÊµÅÈáëÊ≠≤Êúà", colors: ['#f6d365', '#fda085'], enabled: true },
            { name: "ÂçàÂ§úÈúìËôπ", colors: ['#00c6fb', '#005bea'], enabled: true },
            { name: "ÁîúËúúÊô®ÂÖâ", colors: ['#fa709a', '#fee140'], enabled: true },
            { name: "Êò•ÊÑèÁõéÁÑ∂", colors: ['#43e97b', '#38f9d7'], enabled: true },
            { name: "ÁèäÁëöÊó•ËêΩ", colors: ['#ff6b6b', '#feca57'], enabled: true },
            { name: "Êµ∑Ê¥ãÂæÆÈ¢®", colors: ['#48dbfb', '#0abde3'], enabled: true },
            { name: "ÁÜ±Â∏∂ÁÉàÁÅ´", colors: ['#ee5a6f', '#f39c12'], enabled: true },
            { name: "Ê∑±ÈÇÉÁ¥´", colors: ['#5f27cd', '#341f97'], enabled: true },
            { name: "Ê∏ÖÊñ∞ËñÑËç∑", colors: ['#00d2d3', '#1dd1a1'], enabled: true },
            { name: "Á≥ñÊûúÂ§¢Â¢É", colors: ['#ff9ff3', '#feca57'], enabled: true },
            { name: "Â§©Á©∫Ëóç", colors: ['#54a0ff', '#2e86de'], enabled: true },
            { name: "ÁÅ´ÁÜ±Á¥Ö", colors: ['#ff6348', '#ff4757'], enabled: true },
            { name: "Áø°Áø†Á∂†", colors: ['#1abc9c', '#16a085'], enabled: true },
            { name: "ÈúìËôπÁ¥´", colors: ['#e056fd', '#686de0'], enabled: true },
            { name: "ÈªÉÈáëÊ©ô", colors: ['#ffd32a', '#ff8c00'], enabled: true }
        ];

        let isNightMode = false, isBlinking = true, isLiquidVisible = true, is24Hour = true, isDateVisible = true, currentPaletteIndex = 0, lastHours = '';
        let liquidSettings = { opacity: 0.3, rise: 'smooth', surface: 'wave', interact: false, reset: 'instant', scaleWidth: 1.5, waterFill: true, waveHeight: 75 };

        // Performance Mode: 'standard', 'powersave', 'ultrasave'
        let performanceMode = 'powersave';
        const PERF_CONFIGS = {
            standard: { waveFPS: 30, digitAnim: 'ÊóãËΩâ + Á∏ÆÊîæ', duration: '3 Áßí', gpu: 'ÂïüÁî®', warnings: [] },
            powersave: { waveFPS: 15, digitAnim: 'Ê∑°ÂÖ•Ê∑°Âá∫', duration: '0.5 Áßí', gpu: 'ÂÅúÁî®', warnings: [] },
            ultrasave: { waveFPS: 0, digitAnim: 'ÁÑ°', duration: '0 Áßí', gpu: 'ÂÅúÁî®', warnings: ['Ê∂≤È´îË®≠ÂÆö > Ê∞¥Èù¢Ê®£Âºè (Ê≥¢Êµ™)', 'Ê∂≤È´îË®≠ÂÆö > È°èËâ≤‰∫§‰∫í (‰∫§Êèõ)'] }
        };

        const body = document.body, nightOverlay = document.getElementById('night-overlay');
        const btnNight = document.getElementById('toggle-night');
        const btnPalette = document.getElementById('toggle-palette');
        const btnLiquid = document.getElementById('toggle-liquid');
        const btnRandom = document.getElementById('btn-random');
        const btnTimeSettings = document.getElementById('toggle-time-settings');
        const btnPerformance = document.getElementById('toggle-performance');

        const liquidPanel = document.getElementById('liquid-settings-panel');
        const palettePanel = document.getElementById('palette-panel');
        const timeSettingsPanel = document.getElementById('time-settings-panel');
        const performancePanel = document.getElementById('performance-panel');
        const timeContainer = document.getElementById('time'), minutesContainer = document.getElementById('minutes-row');
        const clockContainer = document.getElementById('clock-container'), dateElement = document.getElementById('date');
        const liquidContainer = document.getElementById('liquid-container'), liquidScale = document.getElementById('liquid-scale');
        const liquidSecondLabel = document.getElementById('liquid-second-label');

        // Smart Scale Detection
        function handleSafeAreas() {
            // Priority 1: Check CSS Safe Areas directly via hidden element
            const div = document.createElement('div');
            div.style.paddingLeft = 'env(safe-area-inset-left)';
            div.style.paddingRight = 'env(safe-area-inset-right)';
            div.style.position = 'absolute';
            div.style.visibility = 'hidden';
            document.body.appendChild(div);

            const pl = parseFloat(getComputedStyle(div).paddingLeft) || 0;
            const pr = parseFloat(getComputedStyle(div).paddingRight) || 0;
            document.body.removeChild(div);

            let flipped = false;

            // Decision Logic:
            // 1. If Left Inset > Right Inset, Notch is Left. -> Scale Flipped (Right).
            // 2. If Right Inset > Left Inset, Notch is Right. -> Scale Normal (Left).
            // 3. If Insets are equal (or zero), fallback to Orientation Angle.
            //    - Angle 90: Top Left (Notch Left) -> Scale Flipped.
            //    - Angle -90: Top Right (Notch Right) -> Scale Normal.

            if (pl > pr && pl > 20) {
                flipped = true;
            } else if (pr > pl && pr > 20) {
                flipped = false;
            } else {
                // Fallback to orientation
                const angle = window.screen?.orientation?.angle || window.orientation || 0;
                if (angle === 90) {
                    flipped = true;
                }
            }

            if (flipped) {
                body.classList.add('scale-flipped');
            } else {
                body.classList.remove('scale-flipped');
            }
        }
        window.addEventListener('resize', handleSafeAreas);
        window.addEventListener('orientationchange', () => setTimeout(handleSafeAreas, 200));

        // ... (existing functions)

        function updateControlStates() {
            const s = document.getElementById('section-scalewidth'), w = document.getElementById('section-waterfill');
            const wh = document.getElementById('section-waveheight');

            if (liquidSettings.surface === 'line') {
                s.classList.remove('disabled');
                w.classList.remove('disabled');
                wh.classList.add('disabled'); // Wave Height irrelevant for Line
                if (liquidSettings.waterFill && liquidSettings.rise !== 'step') {
                    applyRiseMode('step');
                }
            } else if (liquidSettings.surface === 'flat') {
                s.classList.add('disabled');
                w.classList.add('disabled');
                wh.classList.add('disabled'); // Wave Height irrelevant for Flat
            } else {
                s.classList.add('disabled');
                w.classList.add('disabled');
                wh.classList.remove('disabled'); // Wave Height active
            }
            updatePanelUI();
        }

        // ...

        function updatePanelUI() {
            // Liquid Panel
            document.querySelectorAll('#liquid-settings-panel .panel-option').forEach(opt => {
                const st = opt.dataset.setting, val = opt.dataset.value;
                let isActive = false;
                if (st === 'master') isActive = (val === (isLiquidVisible ? 'on' : 'off'));
                else if (st === 'interact') {
                    const current = liquidSettings.interact;
                    if (val === 'swap') isActive = (current === 'swap');
                    else if (val === 'on') isActive = (current === true || current === 'on');
                    else if (val === 'off') isActive = (current === false || current === 'off');
                }
                else if (st === 'waterfill') isActive = (val === (liquidSettings.waterFill ? 'on' : 'off'));
                else if (st === 'scalewidth') isActive = (parseFloat(val) === liquidSettings.scaleWidth);
                else if (st === 'opacity') isActive = (parseFloat(val) === liquidSettings.opacity);
                else if (st === 'waveheight') isActive = (parseInt(val) === liquidSettings.waveHeight);
                else isActive = (val === liquidSettings[st]);

                opt.classList.toggle('active', isActive);
            });

            // Time Settings Panel
            document.querySelectorAll('#time-settings-panel .panel-option').forEach(opt => {
                const st = opt.dataset.setting, val = opt.dataset.value;
                let isActive = false;
                if (st === 'format') isActive = (val === (is24Hour ? '24h' : '12h'));
                else if (st === 'date') isActive = (val === (isDateVisible ? 'show' : 'hide'));
                else if (st === 'blink') isActive = (val === (isBlinking ? 'on' : 'off'));

                opt.classList.toggle('active', isActive);
            });
        }

        // ...

        // Listener Update
        document.querySelectorAll('.panel-option').forEach(opt => {
            opt.addEventListener('click', e => {
                const st = e.target.dataset.setting, v = e.target.dataset.value;

                if (st === 'master') { isLiquidVisible = (v === 'on'); body.classList.toggle('show-liquid', isLiquidVisible); }
                else if (st === 'opacity') { liquidSettings.opacity = parseFloat(v); document.documentElement.style.setProperty('--liquid-opacity', v); }
                else if (st === 'waveheight') {
                    liquidSettings.waveHeight = parseInt(v);
                    document.documentElement.style.setProperty('--wave-height', v + 'px');
                }
                else if (st === 'rise') { applyRiseMode(v); updateClock(); }
                else if (st === 'surface') {
                    liquidSettings.surface = v;
                    liquidContainer.classList.remove('surface-wave', 'surface-flat', 'surface-line');
                    body.classList.remove('line-mode', 'show-water-fill');
                    if (v === 'line') {
                        body.classList.add('line-mode');
                        if (liquidSettings.waterFill) {
                            body.classList.add('show-water-fill');
                            if (liquidSettings.rise !== 'step') applyRiseMode('step');
                        }
                    } else {
                        liquidContainer.classList.add('surface-' + v);
                    }
                }
                else if (st === 'interact') {
                    liquidSettings.interact = v;
                    updateInteractMode(v);
                }
                else if (st === 'reset') { liquidSettings.reset = v; }
                else if (st === 'scalewidth') { liquidSettings.scaleWidth = parseFloat(v); document.documentElement.style.setProperty('--scale-width', v); }
                else if (st === 'waterfill') {
                    liquidSettings.waterFill = (v === 'on');
                    body.classList.toggle('show-water-fill', liquidSettings.waterFill && liquidSettings.surface === 'line');
                    if (liquidSettings.waterFill && liquidSettings.surface === 'line' && liquidSettings.rise !== 'step') applyRiseMode('step');
                }
                updateControlStates();
            });
        });

        // ...

        function initClock() {
            handleSafeAreas(); // Init check

            // Main clock
            for (let i = 0; i < 5; i++) { if (i === 2) { const c = document.createElement('span'); c.className = 'colon'; c.textContent = ':'; timeContainer.appendChild(c); } else { const w = document.createElement('div'); w.className = 'digit-wrapper'; const d = document.createElement('span'); d.className = 'digit'; w.appendChild(d); timeContainer.appendChild(w); } }
            for (let i = 0; i < 2; i++) { const w = document.createElement('div'); w.className = 'digit-wrapper'; const d = document.createElement('span'); d.className = 'digit'; w.appendChild(d); minutesContainer.appendChild(w); }

            // Swap clock (same structure)
            const timeSwap = document.getElementById('time-swap');
            const minutesSwap = document.getElementById('minutes-row-swap');

            // Prevention: Clear existing digits to avoid duplication on re-init
            if (timeSwap) timeSwap.innerHTML = '';
            if (minutesSwap) minutesSwap.innerHTML = '';

            if (timeSwap) {
                for (let i = 0; i < 5; i++) { if (i === 2) { const c = document.createElement('span'); c.className = 'colon'; c.textContent = ':'; timeSwap.appendChild(c); } else { const w = document.createElement('div'); w.className = 'digit-wrapper'; const d = document.createElement('span'); d.className = 'digit'; w.appendChild(d); timeSwap.appendChild(w); } }
            }
            if (minutesSwap) {
                for (let i = 0; i < 2; i++) { const w = document.createElement('div'); w.className = 'digit-wrapper'; const d = document.createElement('span'); d.className = 'digit'; w.appendChild(d); minutesSwap.appendChild(w); }
            }

            renderPalettePanel();
            updatePalette(currentPaletteIndex, false);
            handleOrientationChange(portraitQuery);
            updateBlinkingState();
            generateScaleMarks();
            updateControlStates();
        }


        function generateScaleMarks() { liquidScale.innerHTML = ''; for (let i = 0; i <= 60; i++) { const mark = document.createElement('div'); if (i % 10 === 0) mark.className = 'scale-mark major'; else if (i % 5 === 0) mark.className = 'scale-mark medium'; else mark.className = 'scale-mark'; mark.dataset.second = i; mark.style.bottom = `${(i / 60) * 100}%`; liquidScale.appendChild(mark); } }


        function applyRiseMode(mode) {
            liquidSettings.rise = mode;
            const currentHeight = liquidContainer.style.height || '0%';
            liquidContainer.style.transition = 'none';
            liquidContainer.style.height = currentHeight;
            liquidContainer.offsetHeight;
            if (mode === 'step') {
                liquidContainer.classList.add('step-anim');
                liquidContainer.style.transition = '';
            } else {
                liquidContainer.classList.remove('step-anim');
                liquidContainer.style.transition = 'height 1s linear';
            }
        }



        function renderPalettePanel() {
            palettePanel.innerHTML = '';
            PALETTE_DATA.forEach((p, index) => {
                const item = document.createElement('div');
                item.className = 'palette-item';
                if (index === currentPaletteIndex) item.classList.add('active');
                if (!p.enabled) item.classList.add('disabled');

                const preview = document.createElement('div');
                preview.className = 'palette-preview';
                preview.style.background = `linear-gradient(135deg, ${p.colors[0]}, ${p.colors[1]})`;

                const name = document.createElement('div');
                name.className = 'palette-name';
                name.textContent = p.name;

                item.appendChild(preview);
                item.appendChild(name);

                // Click to Select
                item.addEventListener('click', (e) => {
                    if (item.dataset.longPressed === 'true') {
                        item.dataset.longPressed = 'false';
                        return;
                    }
                    if (p.enabled || index === currentPaletteIndex) {
                        updatePalette(index, false);
                    }
                });

                // Long Press to Toggle
                let pressTimer;
                const startPress = (e) => {
                    item.dataset.longPressed = 'false';
                    pressTimer = setTimeout(() => {
                        item.dataset.longPressed = 'true';
                        togglePaletteEnabled(index);
                        if (navigator.vibrate) navigator.vibrate(50);
                    }, 600);
                };

                const cancelPress = (e) => {
                    clearTimeout(pressTimer);
                };

                item.addEventListener('mousedown', startPress);
                item.addEventListener('touchstart', startPress);
                item.addEventListener('mouseup', cancelPress);
                item.addEventListener('mouseleave', cancelPress);
                item.addEventListener('touchend', cancelPress);
                item.addEventListener('contextmenu', e => e.preventDefault());

                palettePanel.appendChild(item);
            });
        }

        function togglePaletteEnabled(index) {
            PALETTE_DATA[index].enabled = !PALETTE_DATA[index].enabled;
            // Update UI
            const item = palettePanel.children[index];
            if (item) {
                item.classList.toggle('disabled', !PALETTE_DATA[index].enabled);
            }
        }

        function updateBlinkingState() {
            // Update Panel State
            updatePanelUI(); // To sync the 'blink' option in panel

            const colons = document.querySelectorAll('.colon');
            const d = document.getElementById('date'), p = portraitQuery.matches;

            colons.forEach(c => c.classList.remove('blink'));
            if (d) d.classList.remove('blink');

            if (isBlinking) {
                if (p && d) {
                    d.classList.add('blink');
                } else {
                    colons.forEach(c => c.classList.add('blink'));
                }
            }
        }
        // JS Driven Wave Animation for Perfect Sync
        // JS Driven Wave Animation for Perfect Sync
        function startWaveAnimation() {
            if (window.waveAnimStarted) return;
            window.waveAnimStarted = true;

            const duration = 5000; // 5 seconds for one cycle
            const start = performance.now();
            const swapContainer = document.getElementById('clock-container-swap');
            const liquidContainer = document.getElementById('liquid-container');

            let lastFrameTime = 0;

            function animate(now) {
                // Background Optimization: Pause RAF loop logic if hidden
                if (document.hidden) {
                    requestAnimationFrame(animate);
                    return;
                }

                // Performance Mode: Get dynamic FPS from config
                const config = PERF_CONFIGS[performanceMode];
                const targetFPS = config.waveFPS;

                // Ultrasave: Complete skip
                if (targetFPS === 0) {
                    requestAnimationFrame(animate);
                    return;
                }

                const frameInterval = 1000 / targetFPS;

                // FPS Throttling
                const delta = now - lastFrameTime;
                if (delta < frameInterval) {
                    requestAnimationFrame(animate);
                    return;
                }
                // Adjust for drift, but careful not to spiral if delta is huge (tab switch)
                lastFrameTime = now - (delta % frameInterval);

                // Skip updates if Surface is not 'wave' (Zero overhead for Flat/Line modes)
                if (liquidSettings.surface !== 'wave') {
                    requestAnimationFrame(animate);
                    return;
                }

                // Calculate phase (0 to 1)
                const elapsed = now - start;
                const phase = (elapsed % duration) / duration;

                // One full cycle is -100vw
                const waveX = phase * -100; // -100vw

                // Performance Optimization: Update variable ONLY on specific elements
                // TARGETING BOTH: Ensures Main Liquid Wave and Swap Mask both move.
                if (swapContainer) swapContainer.style.setProperty('--wave-x', `${waveX}vw`);
                if (liquidContainer) liquidContainer.style.setProperty('--wave-x', `${waveX}vw`);

                requestAnimationFrame(animate);
            }
            requestAnimationFrame(animate);
        }

        const portraitQuery = window.matchMedia('(orientation: portrait)');
        function handleOrientationChange(e) {
            const t = document.getElementById('time-row');
            const ts = document.getElementById('time-row-swap');
            let ds = document.getElementById('date-swap-dummy');

            // Create dummy if doesn't exist
            if (!ds && ts) {
                ds = document.createElement('div');
                ds.id = 'date-swap-dummy';
                ds.textContent = '1Êúà1Êó• ÈÄ±‰∏Ä'; // Placeholder text
                ds.style.visibility = 'hidden';

                // CRITICAL: Match #date CSS exactly to ensure vertical alignment
                // From CSS: #date { font-size: 6vw; margin: 1vh 0; }
                ds.style.fontSize = '6vw';
                ds.style.height = 'auto';
                ds.style.margin = '1vh 0';
                ds.style.fontWeight = '700';
                ds.style.lineHeight = '1.2';
                ds.style.whiteSpace = 'nowrap';
                ds.style.padding = '0'; /* Ensure no padding diff */

                document.body.appendChild(ds);
            }

            if (e.matches) {
                // Portrait: Insert date between time and minutes
                t.insertBefore(dateElement, minutesContainer);
                t.style.flexDirection = 'column';
                t.style.alignItems = 'center';

                if (ts && ds) {
                    const minsSwap = document.getElementById('minutes-row-swap');
                    ts.insertBefore(ds, minsSwap);
                    ts.style.flexDirection = 'column';
                    ts.style.alignItems = 'center';

                    // Sync dummy style with real date
                    const dStyle = window.getComputedStyle(dateElement);
                    ds.style.display = 'block'; // Ensure it takes space
                    // We rely on CSS classes for main styling, but might need to force some dimensions if dynamic
                }
            } else {
                // Landscape: Move date to body
                document.body.appendChild(dateElement);
                t.style.flexDirection = '';
                t.style.alignItems = '';

                if (ts && ds) {
                    document.body.appendChild(ds);
                    ds.style.display = 'none'; // Hide in landscape
                    ts.style.flexDirection = '';
                    ts.style.alignItems = '';
                }
            }
            updateBlinkingState();
            updateClock();
        }
        portraitQuery.addEventListener('change', handleOrientationChange);

        function updateClock() {
            // Optimization: Completely pause clock logic when backgrounded
            if (document.hidden) return;

            const now = new Date(); let h = now.getHours(); const m = now.getMinutes(), s = now.getSeconds();

            // Automatic Palette Change every hour
            if (String(now.getHours()).padStart(2, '0') !== lastHours && lastHours !== '') {
                // Find next enabled palette
                let nextIndex = (currentPaletteIndex + 1) % PALETTE_DATA.length;
                let attempts = 0;
                while (!PALETTE_DATA[nextIndex].enabled && attempts < PALETTE_DATA.length) {
                    nextIndex = (nextIndex + 1) % PALETTE_DATA.length;
                    attempts++;
                }
                if (attempts < PALETTE_DATA.length) {
                    updatePalette(nextIndex, false);
                }
            }
            lastHours = String(now.getHours()).padStart(2, '0');

            if (isLiquidVisible) {
                const pct = (s / 60) * 100;
                document.querySelectorAll('.scale-mark').forEach(mk => mk.classList.remove('current'));
                const cm = document.querySelector(`.scale-mark[data-second="${s}"]`);
                if (cm) cm.classList.add('current');

                if (liquidSettings.rise === 'step') {
                    liquidContainer.classList.add('step-anim');
                    if (s === 0) {
                        if (liquidSettings.reset === 'drain') { liquidContainer.style.transition = 'height 0.8s ease-out'; liquidContainer.style.height = '0%'; }
                        else { liquidContainer.style.transition = 'none'; liquidContainer.style.height = '0%'; liquidContainer.offsetHeight; liquidContainer.style.transition = ''; }
                    } else { liquidContainer.style.height = `${pct}%`; }
                } else {
                    liquidContainer.classList.remove('step-anim');
                    liquidContainer.style.transition = 'height 1s linear';
                    if (s === 0) {
                        if (liquidSettings.reset === 'drain') { liquidContainer.style.transition = 'height 0.8s ease-out'; liquidContainer.style.height = '0%'; }
                        else { liquidContainer.style.transition = 'none'; liquidContainer.style.height = '0%'; liquidContainer.offsetHeight; liquidContainer.style.transition = 'height 1s linear'; }
                    } else { liquidContainer.style.height = `${pct}%`; }
                }

                const th = (30 / window.innerHeight) * 100;
                if (pct > (100 - th - 2)) { liquidSecondLabel.style.bottom = 'auto'; liquidSecondLabel.style.top = `${100 - pct + 1}%`; }
                else { liquidSecondLabel.style.top = 'auto'; liquidSecondLabel.style.bottom = `${pct + 1}%`; }
                liquidSecondLabel.textContent = s + 's';

                // Update Swap Mask Position
                const swapContainer = document.getElementById('clock-container-swap');
                if (swapContainer) {
                    const maskYPx = window.innerHeight * ((100 - pct) / 100);
                    swapContainer.style.setProperty('--mask-y-px', `${maskYPx}px`);

                    // Sync transition with liquid container for smoothness
                    if (s === 0 && liquidSettings.reset !== 'drain') {
                        swapContainer.style.transition = 'none';
                        // Force reflow
                        swapContainer.offsetHeight;
                        swapContainer.style.transition = '--mask-y-px 1s linear';
                    } else if (liquidSettings.rise === 'step') {
                        swapContainer.style.transition = '--mask-y-px 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                    } else {
                        swapContainer.style.transition = '--mask-y-px 1s linear';
                    }
                }
            }

            let ap = ''; const as = document.getElementById('ampm-standalone');
            const swapClockContainer = document.getElementById('clock-container-swap');
            if (!is24Hour) {
                ap = h >= 12 ? 'PM' : 'AM'; h = h % 12 || 12;
                clockContainer.classList.add('mode-12h');
                if (swapClockContainer) swapClockContainer.classList.add('mode-12h');
                if (!isDateVisible) { as.textContent = ap; as.classList.add('visible'); } else { as.classList.remove('visible'); }
            } else {
                clockContainer.classList.remove('mode-12h');
                if (swapClockContainer) swapClockContainer.classList.remove('mode-12h');
                if (as) as.classList.remove('visible');
            }

            const hs = !is24Hour ? String(h) : String(h).padStart(2, '0'), ms = String(m).padStart(2, '0'), h1 = hs.length === 2 ? hs[0] : '', h2 = hs.length === 2 ? hs[1] : hs[0];

            const ws = timeContainer.querySelectorAll('.digit-wrapper');
            updateDigitInWrapper(ws[0], h1, 0, false);
            updateDigitInWrapper(ws[1], h2, 1, false);
            updateDigitInWrapper(ws[2], ms[0], 2, false);
            updateDigitInWrapper(ws[3], ms[1], 3, false);
            const mw = minutesContainer.querySelectorAll('.digit-wrapper');
            updateDigitInWrapper(mw[0], ms[0], 0, true);
            updateDigitInWrapper(mw[1], ms[1], 1, true);

            const wk = ['ÈÄ±Êó•', 'ÈÄ±‰∏Ä', 'ÈÄ±‰∫å', 'ÈÄ±‰∏â', 'ÈÄ±Âõõ', 'ÈÄ±‰∫î', 'ÈÄ±ÂÖ≠'];
            const dateStr = (ap && isDateVisible) ? `${ap}ÔΩú${now.getMonth() + 1}Êúà${now.getDate()}Êó• ${wk[now.getDay()]}` : `${now.getMonth() + 1}Êúà${now.getDate()}Êó• ${wk[now.getDay()]}`;
            document.getElementById('date').textContent = dateStr;

            // Sync dummy date text for perfect alignment in portrait swap
            const ds = document.getElementById('date-swap-dummy');
            if (ds) ds.textContent = dateStr;
        }

        function updateDigitInWrapper(w, nc, wrapperIndex, isMinutesRow) {
            // Optimization: If invalid/hidden (backgrounded), skip animation to prevent RAF buildup
            if (document.hidden) {
                w.textContent = nc;
                const swapContainer = isMinutesRow
                    ? document.getElementById('minutes-row-swap')
                    : document.getElementById('time-swap');
                if (swapContainer) {
                    const swapDigits = swapContainer.querySelectorAll('.digit-wrapper .digit');
                    const swapDigit = swapDigits[wrapperIndex];
                    if (swapDigit) swapDigit.textContent = nc;
                }
                return;
            }

            const cd = w.querySelector('.digit:last-child'), cv = cd ? cd.textContent : '';
            if (cv !== nc) {
                // Safety Cleanup: Ensure no more than 1 old digit exists
                while (w.children.length > 1) {
                    w.removeChild(w.firstChild);
                }

                // Ultrasave: No animation at all
                if (performanceMode === 'ultrasave') {
                    if (cd) cd.textContent = nc;
                    else {
                        const nd = document.createElement('span');
                        nd.className = 'digit';
                        nd.textContent = nc;
                        w.appendChild(nd);
                    }
                    // Sync to swap clock
                    const swapContainer = isMinutesRow
                        ? document.getElementById('minutes-row-swap')
                        : document.getElementById('time-swap');
                    if (swapContainer) {
                        const swapDigits = swapContainer.querySelectorAll('.digit-wrapper .digit');
                        const swapDigit = swapDigits[wrapperIndex];
                        if (swapDigit) swapDigit.textContent = nc;
                    }
                    return;
                }

                const nd = document.createElement('span');
                nd.className = 'digit';
                nd.textContent = nc;
                nd.style.opacity = '0';

                // Standard mode: Use rotation/scale effects
                if (performanceMode === 'standard') {
                    const ip = portraitQuery.matches;
                    let r = 0, sx = 0, sy = 0;
                    if (!ip) {
                        r = Math.random() * 10 - 5;
                        sx = (Math.random() - 0.5) * 2;
                        sy = (Math.random() - 0.5) * 2;
                    }
                    const finalTransform = `rotate(${r}deg) scale(1) translate(${sx}vw, ${sy}vw)`;
                    nd.style.transform = `rotate(${r}deg) scale(0.8) translate(${sx}vw, ${sy}vw)`;
                    w.appendChild(nd);

                    requestAnimationFrame(() => {
                        nd.style.opacity = '1';
                        nd.style.transform = finalTransform;
                        if (cd) {
                            cd.style.opacity = '0';
                            const exitR = ip ? 0 : Math.random() * 10 - 5;
                            cd.style.transform = ip ? 'scale(1.2)' : `rotate(${exitR}deg) scale(1.2) translate(${sx * 1.5}vw, ${sy * 1.5}vw)`;
                            setTimeout(() => { if (cd.parentNode === w) w.removeChild(cd); }, 3000);
                        }
                    });
                } else {
                    // Power save mode: Simple fade
                    w.appendChild(nd);

                    requestAnimationFrame(() => {
                        nd.style.opacity = '1';
                        if (cd) {
                            cd.style.opacity = '0';
                            setTimeout(() => { if (cd.parentNode === w) w.removeChild(cd); }, 600);
                        }
                    });
                }

                // Sync to swap clock
                const swapContainer = isMinutesRow
                    ? document.getElementById('minutes-row-swap')
                    : document.getElementById('time-swap');
                if (swapContainer) {
                    const swapDigits = swapContainer.querySelectorAll('.digit-wrapper .digit');
                    const swapDigit = swapDigits[wrapperIndex];
                    if (swapDigit) {
                        swapDigit.textContent = nc;
                    }
                }
            }
        }

        function updatePalette(index, inc = true) {
            if (isNightMode) return;

            let nextIndex = index;
            if (inc) {
                // Not used mostly, but kept for compatibility logic if needed
                nextIndex = (currentPaletteIndex + 1) % PALETTE_DATA.length;
            }

            currentPaletteIndex = nextIndex;
            const p = PALETTE_DATA[currentPaletteIndex];
            document.documentElement.style.setProperty('--color-a', p.colors[0]);
            document.documentElement.style.setProperty('--color-b', p.colors[1]);

            // Update Active State
            if (palettePanel.children.length > 0) {
                Array.from(palettePanel.children).forEach((child, idx) => {
                    child.classList.toggle('active', idx === currentPaletteIndex);
                });
            }

            // Update Button Text
            const btnText = btnPalette.querySelector('.btn-text');
            if (btnText) btnText.textContent = ` ${p.name}`;
        }

        function randomizeSettings() {
            // Randomize Palette
            const enabledIndices = PALETTE_DATA.map((p, i) => p.enabled ? i : -1).filter(i => i !== -1);
            if (enabledIndices.length > 0) {
                const rIndex = enabledIndices[Math.floor(Math.random() * enabledIndices.length)];
                updatePalette(rIndex, false);
            }

            // Randomize Time Format
            is24Hour = Math.random() > 0.5;
            // Removed button text update, now handled by updatePanelUI at end

            // Randomize Date Visibility
            isDateVisible = Math.random() > 0.3; // 70% chance on
            body.classList.toggle('hide-date', !isDateVisible);

            // Randomize Blink
            isBlinking = Math.random() > 0.5;
            updateBlinkingState();

            // Liquid Master
            isLiquidVisible = Math.random() > 0.1;
            body.classList.toggle('show-liquid', isLiquidVisible);

            // Surfaces
            const surfaces = ['wave', 'flat', 'line'];
            liquidSettings.surface = surfaces[Math.floor(Math.random() * surfaces.length)];

            liquidContainer.classList.remove('surface-wave', 'surface-flat', 'surface-line');
            body.classList.remove('line-mode', 'show-water-fill');
            if (liquidSettings.surface === 'line') {
                body.classList.add('line-mode');
            } else {
                liquidContainer.classList.add('surface-' + liquidSettings.surface);
            }

            // Opacity
            const opacities = [0.15, 0.3, 0.5];
            liquidSettings.opacity = opacities[Math.floor(Math.random() * opacities.length)];
            document.documentElement.style.setProperty('--liquid-opacity', liquidSettings.opacity);

            // Interact
            const rInteract = Math.random();
            if (rInteract < 0.33) liquidSettings.interact = 'off';
            else if (rInteract < 0.66) liquidSettings.interact = 'on';
            else liquidSettings.interact = 'swap';

            // Respect Perf Mode in Random
            if (performanceMode === 'ultrasave' && liquidSettings.interact === 'swap') liquidSettings.interact = 'off';

            updateInteractMode(liquidSettings.interact);

            // Reset
            liquidSettings.reset = Math.random() > 0.5 ? 'instant' : 'drain';

            // Dependent
            if (liquidSettings.surface === 'line') {
                const widths = [1, 1.5, 2];
                liquidSettings.scaleWidth = widths[Math.floor(Math.random() * widths.length)];
                document.documentElement.style.setProperty('--scale-width', liquidSettings.scaleWidth);

                liquidSettings.waterFill = Math.random() > 0.3;
                if (liquidSettings.waterFill) {
                    body.classList.add('show-water-fill');
                    applyRiseMode('step');
                } else {
                    liquidSettings.rise = Math.random() > 0.5 ? 'smooth' : 'step';
                    applyRiseMode(liquidSettings.rise);
                }
            } else {
                liquidSettings.rise = Math.random() > 0.5 ? 'smooth' : 'step';
                applyRiseMode(liquidSettings.rise);
            }

            updateControlStates();
            updatePanelUI(); // Sync all new values to panels
            updateClock();
        }


        // Visibility API: Resume immediately when waking up
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                updateClock();
                // Optionally restart wave if somehow needed, but loop handles resumption automatically
            }
        });

        initClock(); setInterval(updateClock, 1000); updateClock();
        startWaveAnimation(); // Start the sync loop
        // Burn-in jitter disabled for swap alignment
        // setInterval(() => {
        //     const x = Math.floor(Math.random() * MAX_JITTER * 2) - MAX_JITTER, y = Math.floor(Math.random() * MAX_JITTER * 2) - MAX_JITTER;
        //     const transform = `translate(${x}px, ${y}px)`;
        //     clockContainer.style.transform = transform;
        //     const clockContainerSwap = document.getElementById('clock-container-swap');
        //     if (clockContainerSwap) clockContainerSwap.style.transform = transform;
        // }, BURN_IN_INTERVAL);

        // Palette Button Toggle Panel
        btnPalette.addEventListener('click', e => {
            e.stopPropagation();
            palettePanel.classList.toggle('visible');
            liquidPanel.classList.remove('visible');
            timeSettingsPanel.classList.remove('visible');
            performancePanel.classList.remove('visible');
        });

        btnTimeSettings.addEventListener('click', e => {
            e.stopPropagation();
            timeSettingsPanel.classList.toggle('visible');
            palettePanel.classList.remove('visible');
            liquidPanel.classList.remove('visible');
            performancePanel.classList.remove('visible');
        });

        btnLiquid.addEventListener('click', e => {
            e.stopPropagation();
            liquidPanel.classList.toggle('visible');
            palettePanel.classList.remove('visible');
            timeSettingsPanel.classList.remove('visible');
            performancePanel.classList.remove('visible');
        });

        btnPerformance.addEventListener('click', e => {
            e.stopPropagation();
            performancePanel.classList.toggle('visible');
            palettePanel.classList.remove('visible');
            liquidPanel.classList.remove('visible');
            timeSettingsPanel.classList.remove('visible');
        });

        btnRandom.addEventListener('click', e => {
            e.stopPropagation();
            randomizeSettings();
        });

        body.addEventListener('click', e => {
            if (!liquidPanel.contains(e.target) && e.target !== btnLiquid) liquidPanel.classList.remove('visible');
            if (!palettePanel.contains(e.target) && e.target !== btnPalette) palettePanel.classList.remove('visible');
            if (!timeSettingsPanel.contains(e.target) && e.target !== btnTimeSettings) timeSettingsPanel.classList.remove('visible');
            if (!performancePanel.contains(e.target) && e.target !== btnPerformance) performancePanel.classList.remove('visible');
            body.classList.toggle('show-controls');
        });

        liquidPanel.addEventListener('click', e => { e.stopPropagation(); });
        palettePanel.addEventListener('click', e => { e.stopPropagation(); });
        timeSettingsPanel.addEventListener('click', e => { e.stopPropagation(); });
        performancePanel.addEventListener('click', e => { e.stopPropagation(); });

        // Time/Date Settings Panel Handlers
        document.querySelectorAll('#time-settings-panel .panel-option').forEach(opt => {
            opt.addEventListener('click', e => {
                const st = e.target.dataset.setting, v = e.target.dataset.value;

                if (st === 'format') {
                    is24Hour = (v === '24h');
                    body.classList.toggle('mode-12h', !is24Hour);
                    document.getElementById('clock-container-swap').classList.toggle('mode-12h', !is24Hour);
                    updateClock();
                } else if (st === 'date') {
                    // In Portrait, Date is locked visible
                    if (window.matchMedia('(orientation: portrait)').matches && v === 'hide') return;
                    isDateVisible = (v === 'show');
                    body.classList.toggle('hide-date', !isDateVisible);
                    updateClock();
                } else if (st === 'blink') {
                    isBlinking = (v === 'on');
                    updateBlinkingState();
                }

                // Update active states
                const section = e.target.closest('.panel-section');
                section.querySelectorAll('.panel-option').forEach(o => o.classList.remove('active'));
                e.target.classList.add('active');
            });
        });

        // Performance Panel Handlers
        function updatePerformanceDisplay() {
            const config = PERF_CONFIGS[performanceMode];
            document.getElementById('perf-wave').textContent = config.waveFPS === 0 ? 'ÂÅúÁî®' : config.waveFPS + ' fps';
            document.getElementById('perf-digit').textContent = config.digitAnim;
            document.getElementById('perf-duration').textContent = config.duration;
            document.getElementById('perf-gpu').textContent = config.gpu;

            // Warning section
            const warningsSection = document.getElementById('perf-warnings-section');
            const warningList = document.getElementById('perf-warning-list');
            if (config.warnings.length > 0) {
                warningsSection.style.display = 'block';
                warningList.innerHTML = config.warnings.map(w => `<div class="perf-warning-item">‚Ä¢ ${w}</div>`).join('');
            } else {
                warningsSection.style.display = 'none';
            }

            // Update active button
            document.querySelectorAll('#performance-panel .panel-option[data-setting="perfmode"]').forEach(o => {
                o.classList.toggle('active', o.dataset.value === performanceMode);
            });
        }

        function applyPerformanceMode(mode) {
            performanceMode = mode;

            // Apply mode-specific settings
            if (mode === 'ultrasave') {
                // Force disable wave and swap
                liquidSettings.surface = 'flat';
                liquidSettings.interact = 'off';
                liquidContainer.classList.remove('surface-wave', 'surface-line');
                liquidContainer.classList.add('surface-flat');
                body.classList.remove('line-mode', 'swap-active', 'liquid-interact');
            }

            updateControlStates();
            updatePerformanceDisplay();
        }

        document.querySelectorAll('#performance-panel .panel-option[data-setting="perfmode"]').forEach(opt => {
            opt.addEventListener('click', e => {
                applyPerformanceMode(e.target.dataset.value);
            });
        });

        function updateInteractMode(mode) {
            // Block swap in ultrasave mode
            if (performanceMode === 'ultrasave' && mode === 'swap') {
                mode = 'off';
            }
            body.classList.toggle('liquid-interact', mode === 'on');
            body.classList.toggle('swap-active', mode === 'swap');
        }

        function toggleNightMode() { isNightMode = !isNightMode; body.classList.toggle('night-mode', isNightMode); nightOverlay.style.opacity = isNightMode ? '0.6' : '0'; const b = btnNight.querySelector('.btn-text'); if (b) b.textContent = isNightMode ? ' Êó•Èñì' : ' Â§úÈñì'; if (!isNightMode) { const p = PALETTE_DATA[currentPaletteIndex]; document.documentElement.style.setProperty('--color-a', p.colors[0]); document.documentElement.style.setProperty('--color-b', p.colors[1]); } }
        btnNight.addEventListener('click', e => { e.stopPropagation(); toggleNightMode(); });

        // Initialize performance display
        updatePerformanceDisplay();

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').then(() => console.log('SW OK')).catch(e => console.error('SW Fail', e)); }
    </script>
</body>

</html>